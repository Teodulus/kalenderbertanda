<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender Note 2026</title>
    <style>
        /* --- CSS STYLING --- */
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .main-container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h1 { margin: 0; color: #2c3e50; }

        /* Buttons */
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-login { background-color: #3498db; color: white; }
        .btn-register { background-color: #2ecc71; color: white; margin-left: 10px; }
        .btn-logout { background-color: #e74c3c; color: white; display: none; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Calendar Grid */
        .year-grid { display: none; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }

        .month-card { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 5px solid #34495e; }
        .month-title { text-align: center; font-weight: 700; margin-bottom: 10px; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px; }

        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .day-name { font-size: 0.75rem; font-weight: bold; color: #95a5a6; padding-bottom: 5px; }

        .date-cell {
            padding: 8px 0; border-radius: 4px; cursor: pointer; font-size: 0.9rem; position: relative; transition: 0.2s;
        }
        .date-cell:hover { background-color: #ecf0f1; }

        /* Indicators */
        .is-holiday { color: #e74c3c; font-weight: bold; background-color: #fadbd8; }
        .has-note { background-color: #d5f5e3; border: 1px solid #2ecc71; font-weight: bold; color: #27ae60; }
        .empty { pointer-events: none; }

        /* List View Section */
        #notes-list-section { display: none; margin-top: 40px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .note-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .note-item h4 { margin: 0 0 5px 0; color: #2980b9; }
        .note-item p { margin: 0; color: #555; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 400px; position: relative; animation: slideDown 0.3s; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="main-container">
    <div class="top-bar">
        <h1>üìÖ Kalender 2026</h1>
        <div id="auth-buttons">
            <button class="btn-login" onclick="openModal('login-modal')">Masuk</button>
            <button class="btn-register" onclick="openModal('register-modal')">Daftar</button>
        </div>
        <div id="user-info" style="display:none; align-items: center;">
            <span id="welcome-text" style="margin-right: 15px; font-weight: bold; color:#555;"></span>
            <button class="btn-logout" onclick="logout()">Keluar</button>
        </div>
    </div>

    <div id="calendar-area" class="year-grid"></div>

    <div id="notes-list-section">
        <h2>üìù Daftar Semua Catatan Anda</h2>
        <div id="notes-list-container">
            <p style="color: #888;">Belum ada catatan.</p>
        </div>
    </div>

    <div id="landing-msg" style="text-align: center; margin-top: 100px;">
        <h2>Selamat Datang!</h2>
        <p>Silakan Login untuk mengelola jadwal dan catatan Anda.</p>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('login-modal')">&times;</span>
        <h2>Login</h2>
        <div class="form-group"><label>Username</label><input type="text" id="login-u"></div>
        <div class="form-group"><label>Password</label><input type="password" id="login-p"></div>
        <button class="btn-login" style="width:100%" onclick="doLogin()">MASUK</button>
    </div>
</div>

<div id="register-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('register-modal')">&times;</span>
        <h2>Daftar Akun</h2>
        <div class="form-group"><label>Username</label><input type="text" id="reg-u"></div>
        <div class="form-group"><label>Password</label><input type="password" id="reg-p"></div>
        <button class="btn-register" style="width:100%" onclick="doRegister()">DAFTAR</button>
    </div>
</div>

<div id="note-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('note-modal')">&times;</span>
        <h3 id="note-date-display">Tanggal</h3>
        <p id="holiday-display" style="color: #e74c3c; font-size: 0.9rem; margin-top:-10px;"></p>

        <div class="form-group">
            <label>Isi Catatan:</label>
            <textarea id="note-content" rows="5" placeholder="Tulis kegiatan Anda di sini..."></textarea>
        </div>
        <button class="btn-login" style="width:100%" onclick="saveNote()">Simpan Catatan</button>
    </div>
</div>

<script>
    // --- KONFIGURASI DAN DATA ---
    const holidays = { "1-1": "Tahun Baru", "3-19": "Nyepi", "3-21": "Idul Fitri", "5-27": "Idul Adha", "8-17": "Kemerdekaan RI", "12-25": "Natal" }; // (Tambahkan data libur lengkap di sini sesuai kebutuhan)
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

    let authHeader = null;
    let myNotes = []; // Menyimpan data notes dari server
    let selectedDate = ""; // Menyimpan tanggal yang sedang diklik

    // --- FUNGSI MODAL ---
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- AUTHENTICATION ---
    async function doLogin() {
        const u = document.getElementById('login-u').value;
        const p = document.getElementById('login-p').value;
        const creds = 'Basic ' + btoa(u + ":" + p);

        try {
            // Kita coba fetch data notes untuk ngetes login
            const res = await fetch('/api/notes', { headers: { 'Authorization': creds } });

            if (res.ok) {
                authHeader = creds;
                myNotes = await res.json(); // Simpan data notes yang didapat

                document.getElementById('welcome-text').innerText = "Halo, " + u;
                uiLoginSuccess();
                closeModal('login-modal');
                renderCalendar();
                renderNotesList();
            } else {
                alert("Login Gagal! Username/Password salah.");
            }
        } catch (err) { alert("Error koneksi ke server."); console.error(err); }
    }

    async function doRegister() {
        const u = document.getElementById('reg-u').value;
        const p = document.getElementById('reg-p').value;

        try {
            const res = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p, role: 'USER' })
            });

            if (res.ok) {
                alert("Registrasi Berhasil! Silakan Login.");
                closeModal('register-modal');
                openModal('login-modal');
            } else {
                alert("Gagal Register. Username mungkin sudah ada.");
            }
        } catch (err) { alert("Error koneksi."); }
    }

    function logout() { location.reload(); }

    function uiLoginSuccess() {
        document.getElementById('auth-buttons').style.display = 'none';
        document.getElementById('landing-msg').style.display = 'none';
        document.getElementById('user-info').style.display = 'flex';
        document.getElementById('logout-btn').style.display = 'block'; // Di dalam user-info
        document.getElementById('calendar-area').style.display = 'grid';
        document.getElementById('notes-list-section').style.display = 'block';
    }

    // --- LOGIKA KALENDER ---
    function renderCalendar() {
        const container = document.getElementById('calendar-area');
        container.innerHTML = "";

        for (let m = 0; m < 12; m++) {
            const card = document.createElement('div');
            card.className = 'month-card';

            const title = document.createElement('div');
            title.className = 'month-title';
            title.innerText = months[m];
            card.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'days-grid';

            // Header Hari
            ['M','S','S','R','K','J','S'].forEach(d => {
                const day = document.createElement('div');
                day.className = 'day-name';
                day.innerText = d;
                grid.appendChild(day);
            });

            const date = new Date(2026, m, 1);
            const startDay = date.getDay();
            const totalDays = new Date(2026, m + 1, 0).getDate();

            // Kosongkan awal bulan
            for(let i=0; i<startDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Isi Tanggal
            for(let d=1; d<=totalDays; d++) {
                const cell = document.createElement('div');
                cell.className = 'date-cell';
                cell.innerText = d;

                // Format Tanggal: YYYY-MM-DD (Supaya cocok dengan Database)
                // Kita gunakan field 'title' di backend sebagai penyimpan Tanggal
                const dateString = `2026-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                // Cek Libur
                const holidayKey = `${m+1}-${d}`;
                if(holidays[holidayKey]) {
                    cell.classList.add('is-holiday');
                    cell.title = holidays[holidayKey];
                }

                // Cek apakah ada catatan di tanggal ini
                // LOGIKA: Mencocokkan 'title' dari database dengan 'dateString' hari ini
                const existingNote = myNotes.find(n => n.title === dateString);

                if (existingNote) {
                    cell.classList.add('has-note'); // Beri warna hijau
                }

                // Event Klik
                cell.onclick = () => openNote(dateString, holidayKey, existingNote);
                grid.appendChild(cell);
            }

            card.appendChild(grid);
            container.appendChild(card);
        }
    }

    // --- LOGIKA NOTES ---
    function openNote(dateStr, holKey, noteObj) {
        selectedDate = dateStr; // Simpan tanggal yang diklik
        document.getElementById('note-date-display').innerText = "Tanggal: " + dateStr;

        // Tampilkan info libur jika ada
        const holText = holidays[holKey] ? "Libur: " + holidays[holKey] : "";
        document.getElementById('holiday-display').innerText = holText;

        // Isi textarea jika sudah ada catatan sebelumnya
        if (noteObj) {
            document.getElementById('note-content').value = noteObj.content;
        } else {
            document.getElementById('note-content').value = "";
        }

        openModal('note-modal');
    }

    async function saveNote() {
        const content = document.getElementById('note-content').value;
        if (!content.trim()) return;

        // Kita gunakan field 'title' untuk menyimpan TANGGAL
        // Backend: Note { title, content } -> Frontend: { title: "2026-01-01", content: "Isi..." }
        const payload = {
            title: selectedDate,
            content: content
        };

        try {
            const res = await fetch('/api/notes', {
                method: 'POST',
                headers: {
                    'Authorization': authHeader,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                // Refresh data setelah simpan
                const refreshRes = await fetch('/api/notes', { headers: { 'Authorization': authHeader } });
                myNotes = await refreshRes.json();

                renderCalendar(); // Gambar ulang kalender (biar jadi hijau)
                renderNotesList(); // Update list di bawah
                closeModal('note-modal');
            } else {
                alert("Gagal menyimpan catatan.");
            }
        } catch (e) { alert("Error saving note."); }
    }

    function renderNotesList() {
        const listContainer = document.getElementById('notes-list-container');
        listContainer.innerHTML = "";

        if (myNotes.length === 0) {
            listContainer.innerHTML = "<p>Belum ada catatan tersimpan.</p>";
            return;
        }

        // Urutkan berdasarkan tanggal (title)
        myNotes.sort((a, b) => a.title.localeCompare(b.title));

        myNotes.forEach(n => {
            const item = document.createElement('div');
            item.className = 'note-item';
            item.innerHTML = `
                <h4>üìÖ ${n.title}</h4>
                <p>${n.content}</p>
            `;
            listContainer.appendChild(item);
        });
    }
</script>

</body>
</html>